import logging
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# Логирование
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# Токен бота
BOT_TOKEN = "8375816364:AAEJayebQrIrE1FxITjVQqaE-O3GfHWnjM0"

# Состояния
MAIN = "main"
ISMП = "ismp"
KRITERII = "kriterii"
STANDART_DEFINITIONS = "standart_definitions"
IAI = "iai"
IDP = "idp"
IDP_OPR = "idp_opr"
IDP_KRIT = "idp_krit"
IMP = "imp"
IMP_VIDY = "imp_vidy"
IOHV = "iohv"
IOHV_VIDY = "iohv_vidy"
IK = "ik"
IK_VIDY = "ik_vidy"
VYAVLENНЫЕ = "vyavlennye"

# Хранилище состояний (в продакшене — БД)
user_state = {}


# Клавиатура с "Назад" и "В начало"
def make_keyboard(buttons, with_back=True, with_home=True):
    kb = [[KeyboardButton(b)] for b in buttons]
    row = []
    if with_back:
        row.append(KeyboardButton("Назад"))
    if with_home:
        row.append(KeyboardButton("В начало"))
    if row:
        kb.append(row)
    return ReplyKeyboardMarkup(kb, resize_keyboard=True, one_time_keyboard=False)


# --- ТЕКСТЫ (см. ТЗ) ---
# Все тексты включены в полном объёме

COMMISSION = """Председатель:
• Заместитель главного врача по медицинской части - Малышкина Ольга Александровна;
Секретарь:
• Врач-эпидемиолог – Чигиринов Иван Александрович;
Члены комиссии:
• Заместитель главного врача по клинико-экспертной работе – Москалева Марина Александровна;
• Заведующий отделением анестезиологии и реанимации с палатой РИТ- врач-анестезиолог-реаниматолог – Теймуров Тимур Юсыфович;
• Заведующий хирургическим отделением-врач-хирург – Булатов Алексей Юрьевич;
• Заведующий отделением стационара-врач-кардиолог – Хомяченко Ольга Ивановна;
• Заведующий амбулаторно-поликлиническим отделением-врач-терапевт – Оразмагомедова Эльвира Вячеславовна;
• Заведующий клинико-диагностической лабораторией – Мерко Максим Михайлович;
• Заведующий эндоскопическим отделением-врач-эндоскопист – Сигаева Юлия Сергеевна;
• Клинический фармаколог – Борисов Алексей Михайлович;
• Заведующий аптекой -Ремпенинг Анастасия Андреевна;
• Главная медицинская сестра – Кочергина Лилия Алексеевна;"""

KRITERII_SOTR = """1. клинически распознаваемое, в том числе с учетом результатов лабораторных исследований; 
2. возникло у работника при выполнении трудовых обязанностей в результате профессиональной деятельности; 
3. связано с оказанием медицинской помощи; 
4. не выявлено у работника при поступлении на работу в данную медицинскую организацию, в том числе в инкубационном периоде; 
5. не является обострением хронического инфекционного заболевания, имевшегося у работника до начала работы."""

KRITERII_PAT = """1. клинически распознаваемое, в том числе с учетом результатов лабораторных исследований; 
2. возникло в результате поступления пациента в медицинскую организацию или обращения за оказанием медицинской помощи вне зависимости от времени появления симптомов заболеваний; 
3. непосредственная связь их возникновения с оказанием медицинской помощи (лечением, диагностическими исследованиями, иммунизацией и пр.);
4. отсутствовало у пациента при госпитализации или обращении за оказанием медицинской помощи в медицинскую организацию, в том числе в инкубационном периоде заболевания, кроме случаев инфекций, связанных с предшествующей госпитализацией или предшествующим обращением за оказанием медицинской помощи в медицинскую организацию; 
5. не является закономерным продолжением патологического процесса, имевшегося у пациента при госпитализации или обращении за оказанием медицинской помощи; 
6. не является обострением хронического инфекционного заболевания, имевшегося у пациента при госпитализации или обращении за оказанием медицинской помощи;"""

PROFILAKTIKA = """1. Соблюдение стандартных мер предосторожности 
• Гигиена рук – СОП-044-РН-СТ; СОП-045-РН-СТ;
• Использование средств индивидуальной защиты (СИЗ) – СОП-13-23-РН-СТ;
• Безопасное обращение с инъекционными препаратами- И-058-РН-СТ;
• Обработка поверхностей и оборудования – И-025-РН-СТ;
2. Стерилизация и дезинфекция медицинских изделий- И-018-РН-СТ; И-РН-СТ-2023-11-1;
3. Профилактика инфекций при инвазивных процедурах – СОП-6,7,8,9,10,11,12-РН-СТ;
4. Антибиотикопрофилактика и рациональное использование антибиотиков- И-065-РН-СТ; И-060-РН-СТ;
5. Изоляция и контроль за источниками инфекции – СОП-14-23-РН-СТ;
6. Вакцинация медицинского персонала – И-039
• Обязательная вакцинация против:
• Гепатита B (при отсутствии сведений о вакцинации/сведений о наличии антител)
• Корь, краснуха, паротит (при отсутствии сведений о вакцинации/сведений о наличии антител)
• Грипп (ежегодно)
• Дифтерия, столбняк, коклюш (1 раз в 10 лет)
7. Организационные меры – И-022-РН-СТ"""

ABBREVIATURY = """Перечень основных аббревиатур:
• ИАИ - имплантат-ассоциированная инфекция 
• ИВЛ – искусственная вентиляция легких 
• ИМП - инфекция мочевыводящих путей 
• ИДП - инфекции дыхательных путей
• ИСМП - инфекция (инфекционная болезнь), связанная с оказанием медицинской помощи
• ИОХВ - инфекция области хирургического вмешательства 
• КАИК - катетер-ассоциированная инфекция кровотока 
• ПАИ - перелом-ассоциированная инфекция 
• ППИ - перипротезная инфекция 
• ПВК- периферический венозный катетер 
• СОС – стандартное определение случая 
• ЦВК – центральный венозный катетер"""

# --- ИАИ ---
DEF_IAI = """Имплантат-ассоциированная инфекция- острая или хроническая инфекция области хирургического вмешательства, развившаяся после имплантации.
Перипротезная инфекция- острая или хроническая инфекция области хирургического вмешательства, развившаяся после имплантации эндопротеза, представляет собой частный случай имплантатассоциированной инфекции.
Перелом-ассоциированная инфекция- острый или хронический инфекционный процесс в области перелома костей, элементов остеосинтезирующего устройства (пластина, стержень, аппарат внешней фиксации и т.д.) и окружающих тканей"""

PRIZN_IAI = """1) Пациент имеет, по крайней мере, один из следующих признаков:
 свищевой ход, идущий в полость сустава;
 гнойное отделяемое из дренажа, установленного в полость протезированного сустава;
 выделение микроорганизмов из жидкости или ткани, полученной асептически из области протезированного сустава любым методом;
 дополнительно для перипротезной инфекции (ППИ) - количество лейкоцитов > 3000/мкл и/или доля нейтрофильных гранулоцитов > 70% в суставном аспирате при цитологическом исследовании.
2) И
при осмотре, во время повторной операции, при микробиологическом, гистопатологическом или рентгенологическом исследовании (фистулографии) обнаружение признаков инфекции, вовлекающей область протезированного сустава или вовлекающей область перелома и/или остеосинтеза"""

FAKTORY_PPI = """• Сахарный диабет
• Ожирение или истощение
• Цирроз печени
• Алкоголизм
• Наркомания
• Хроническая почечная недостаточность (ХПН)
• Иммуносупрессия (терапия глюкокортикоидами, цитостатиками, ВИЧ)
• Спленэктомия
• Ревматические заболевания
• Предшествующие операции (инвазивные манипуляции) в области сустава
• Наличие удалённых очагов инфекции"""

TIPY_PPI = """I - Острая послеоперационная (менее 4 недель)
II  - Поздняя хроническая (от 4 недель до одного года)
III - Острая гематогенная/отсроченная (через год и более)
IV - Положительная интраоперационная культура (положительные посевы в 2–5 интраоперационных образцах тканей)"""

PUTI_PPI = """I и II – Периоперационный путь (возбудители - S. Аureus; Streptococcus sp.; Enterococcus sp.; Коагулазонегативные стафилококки)
III – Гематогенный путь (возбудители - S. Аureus; Streptococcus sp.; P. Acnes; E. Сoli)
IV -  Гематогенный и периоперационный путь (возбудители - Коагулазонегативные стафилококки)"""

DEYSTVIA_IAI = """1) Лечащий врач информирует руководителя своего структурного подразделения и врача-эпидемиолога о подозрении на указанную инфекцию посредством электронного письма с указанием следующих критериев:
• Ф.И.О. пациента, дата рождения, номер ЭМК;
• дата появления симптомов, указывающих на ИОХВ;
• возникшие симптомы.
2) взять биологический материал для проведения лабораторного исследования у пациента из потенциального источника инфекции (до начала приема антимикробных препаратов), с целью подтверждения или опровержения диагноза инфекционного заболевания, а также этиологической расшифровки возбудителя (при наличии) инфекционного заболевания;
3) при необходимости обеспечить перевод в специализированный стационар, согласно маршрутизации;
4) выявить круг контактных лиц (список предоставить врачу эпидемиологу) из числа пациентов и персонала;
5) провести экстренную профилактику контактных с клиническими проявлениями инфекционного заболевания (при необходимости);"""

# --- ИДП ---
IOD_PNEVMONIA = """Пневмония, связанная с оказанием медицинской помощи - пневмония, развившаяся через 48 ч и более после поступления в медицинскую организацию или обращения за оказанием медицинской помощи, в т.ч. госпитализации в стационар (внутрибольничная пневмония). Делятся на :
1) пневмонии, связанные с оказанием медицинской помощи, без микробиологического подтверждения; 
2) пневмонии, связанные с оказанием медицинской помощи, микробиологически подтвержденные. 
3) также выделяют пневмонии, связанные с искусственной вентиляцией легких (ИВЛ ассоциированные пневмонии), которые также могут быть микробиологически подтвержденные или без микробиологического подтверждения."""

IOD_KRIT_BEZ_MICROB = """ развилась через 48 часов и более после поступления в медицинскую организацию или обращения за оказанием медицинской помощи; 
 не является закономерным развитием основного заболевания. 
И

Наличие признаков пневмонии при рентгенологическом исследовании или КТ- 25 сканировании грудной клетки (инфильтрат, консолидация, кавитация) 
И

Не менее двух из следующих симптомов:
1) лихорадка > 38,0°C без других причин; 
2) лейкопения (< 4 000 лейкоцитов/мм3 ) или лейкоцитоз (≥ 12 000 лейкоцитов/мм3 ). 
3) вновь появившаяся гнойная мокрота или изменение характера мокроты (цвет, запах, количество, консистенция); 
4) кашель, диспноэ или тахипноэ;
5) подозрение при аускультации (хрипы, крепитация или звуки бронхиального дыхания); 
6) ухудшение газообмена (например, O2- десатурация или увеличение потребности в кислороде или увеличение потребности в вентиляции).
Примечания: 
** У пациентов с сопутствующими заболеваниями сердца или легких (респираторный дистресс-синдром, бронхо-легочная дисплазия, отек легких, хроническая обструктивная болезнь легких и др.) может понадобиться дополнительное рентгенологическое исследование или КТ-сканирование легких."""

IOD_KRIT_S_MICROB = """ развилась через 48 часов и более после поступления в медицинскую организацию или обращения за оказанием медицинской помощи; 
 не является закономерным развитием основного заболевания. 
И 

1. Наличие признаков пневмонии при рентгенологическом исследовании или КТ-сканировании грудной клетки*, ** 
И 

2. Как минимум один из следующих симптомов: 
 лихорадка > 38,0°C без других причин: 
 лейкопения (< 4 000 лейкоцитов/мм3 ) или лейкоцитоз (≥ 12 000 лейкоцитов/мм3 ). 
И 

3. Один из следующих симптомов (или не менее двух, если имеется высев культуры из мокроты или положительный неколичественный посев материала из нижних отделов дыхательных путей): 
 вновь появившаяся гнойная мокрота, или изменение характера мокроты (цвет, запах, 26 количество, консистенция);
 кашель, диспноэ или тахипноэ;
 подозрение при аускультации (хрипы, крепитация или звуки бронхиального дыхания);
 ухудшение газообмена (например, O2- десатурация или увеличение потребности в кислороде, или увеличение потребности в вентиляции). 
И 

4. Как минимум один из следующих результатов микробиологических исследований: 
 положительный количественный высев из минимально контаминированных образцов нижних дыхательных путей с пороговой величиной: 
• при бронхо-альвеолярном лаваже (БАЛ) > 10*4 КОЕ/мл или при прямом микроскопическом исследовании ≥ 5% клеток, содержащих бактерии, расположенные внутриклеточно; 
• защищенной щеткой > 10*3 КОЕ/мл; 
• дистальной защищенной аспирацией > 10*3 КОЕ/мл.
 положительный количественный высев из возможно контаминированного образца с пороговой величиной: 
• из образца нижних дыхательных путей (например, эндотрахеальный аспират) 10*6 КОЕ/мл. 
 положительный высев из крови, не связанный с инфекцией другой локализации; - положительный высев из аспирата при пункции легочного абсцесса; 
 положительный результат исследования на присутствие респираторных вирусов (гриппа, РС-Вирусы, аденовирусы, коронавирусы, бокавирусы, метапневмовирусы и др.) или микроорганизмов (например, Legionella spp., Aspergillus spp., и другие): 
• обнаружение вирусных антигенов или антител в респираторном секрете (молекулярно-биологическими, иммунохроматографическими методами); 
• сероконверсия (например, вирус гриппа, Legionella spp., Mycoplasma spp.); 
• обнаружение антигенов в моче 27 (Legionella spp., S. Pneumoniae). - положительный высев из мокроты***
Примечания:
• * Инфильтрат, консолидация, кавитация 
• ** У пациентов с сопутствующими заболеваниями сердца или легких (респираторный дистресс-синдром, бронхо - легочная дисплазия, отек легких, хроническая обструктивная болезнь легких и др.) может понадобиться дополнительное рентгологическое исследование или КТ-сканирование легких 
• *** Данный критерий используется только в целях эпидемиологической диагностики."""

IOD_IVL = """1. Пневмония определяется как связанная с искусственной вентиляцией легких (ИВЛ)*, если пневмония развилась не ранее, чем через 48 ч от момента начала проведения ИВЛ, при отсутствии признаков легочной инфекции на момент начала ИВЛ. ** 
И

2. Должна соответствовать критериям пневмонии, связанной с оказанием медицинской помощи, без микробиологического подтверждения.
ИЛИ 

3. Должна соответствовать критериям пневмонии, связанной с оказанием медицинской помощи, микробиологически подтвержденной. 
Примечания: 
* К ИВЛ относится респираторная поддержка, осуществляемая через трахеостому или эндотрахеальную интубацию. 
** Если ИВЛ была начата в день появления симптомов пневмонии без дополнительной информации о последовательности событий, пневмония не рассматривается как связанная с ИВЛ."""

DEYSTVIA_IOD = """Лечащий врач при подозрении на ИОД должен:
1) незамедлительно изолировать пациента в отдельную палату (палату-изолятор);
2) информировать руководителя своего структурного подразделения и врача-эпидемиолога о подозрении на указанную инфекцию устно (по телефону) и электронного письма с указанием следующих критериев:
• Ф.И.О. пациента, дата рождения, номер ЭМК;
• дата постановки инвазивного устройства;
• дата смены устройства/комплектующих, его промывки;
• дата санации;
• дата появления симптомов, указывающих на ИОД;
• возникшие симптомы;
• приложить инструкцию к используемому оборудованию.

3) взять биологический материал для проведения лабораторного исследования у пациента из потенциального источника инфекции (до начала приема антимикробных препаратов), с целью подтверждения или опровержения диагноза инфекционного заболевания, а также этиологической расшифровки возбудителя (при наличии) инфекционного заболевания;
4) при необходимости обеспечить перевод в специализированный стационар, согласно маршрутизации;
5) выявить круг контактных лиц (список предоставить врачу эпидемиологу) из числа пациентов и персонала;
6) провести экстренную профилактику контактных с клиническими проявлениями инфекционного заболевания (при необходимости);"""

# --- ИМП ---
IMP_OPR = """Инфекции мочевыделительных путей (ИМП) - это воспалительное заболевание, вызванное проникновением и размножением патогенных микроорганизмов в одном или нескольких отделах мочевыделительной системы. Их делят на 
- микробиологически подтвержденная симптоматическая ИМП;
- не подтвержденная микробиологически симптоматическая ИМП. 
- также выделяют катетер-ассоциированную ИМП"""

IMP_MICROB = """Должна соответствовать следующим критериям: 
1. Отсутствовать у пациента при поступлении, в том числе в инкубационном периоде. 
2. Не является закономерным развитием основного заболевания. 
И
3. У пациента есть, по крайней мере, один из следующих симптомов без какой-либо другой установленной причины: 
- лихорадка (> 38°C); 
- резкие позывы к мочеиспусканию; 
- учащенное мочеиспускание; 
- дизурия или в болезненность надлобковой области.
И 
4. По крайней мере, одно из следующих: 
- выделение урокультуры в количестве ≥ 105 КОЕ/мл мочи, не более, чем 2 видов микроорганизмов; 
- две повторно выделенные урокультуры одного и того же микроорганизма в количестве ≥ 102 КОЕ/мл из проб, взятых асептически; 
- одна урокультура микроорганизма в количестве ≤ 105 КОЕ/мл у пациента, получающего соответствующую антимикробную терапию."""

IMP_BEZ_MICROB = """Должна соответствовать следующим критериям: 
- отсутствовать у пациента при поступлении, в том числе в инкубационном периоде; 
- не является закономерным развитием основного заболевания. 
И
2. У пациента, по крайней мере, один из следующих симптомов без какой-либо другой установленной причины: 
- лихорадка (> 38°C); 
- резкие позывы к мочеиспусканию; 
- учащенное мочеиспускание; 
- дизурия или болезненность надлобковой области. 
И
3. По крайней мере, одно из следующих: 
- пиурия с количеством лейкоцитов ≥ 10 в 1 мл или ≥ 3 лейкоцита в поле зрение при микроскопии с высоким разрешением образца нецентрифугированной мочи;
- обнаружением микроорганизма при окраске по Граму образца нецентрифугированной мочи; 
- назначение врачом соответствующей антимикробной терапии."""

IMP_KATETER = """Должна соответствовать следующим критериям: 
1.Катетер-ассоциированной ИМП считается инфекция, соответствующая стандартным определениям ИМП. 
И
2.Возникшая у пациента не ранее, чем через 48 часов после постановки внутреннего мочевого катетера. 
ИЛИ
3.Возникшая у пациента в течение 48 часов после удаления внутреннего мочевого катетера, стоявшего не менее 48 часов."""

DEYSTVIA_IMP = """Лечащий врач при подозрении на ИМП должен:
1) информировать руководителя своего структурного подразделения и врача-эпидемиолога о подозрении на указанную инфекцию устно (по телефону) и электронного письма с указанием следующих критериев:
• Ф.И.О. пациента, номер ЭМК;
• наличие в анамнезе хронического процесса
• дата постановки инвазивного устройства;
• дата смены устройства/комплектующих, его промывки;
• дата санации;
• дата появления симптомов, указывающих на ИМП;
• возникшие симптомы;

2) взять биологический материал для проведения лабораторного исследования у пациента из потенциального источника инфекции (до начала приема антимикробных препаратов), с целью подтверждения или опровержения диагноза инфекционного заболевания, а также этиологической расшифровки возбудителя (при наличии) инфекционного заболевания;
3) при необходимости обеспечить перевод в специализированный стационар, согласно маршрутизации;
4) выявить круг контактных лиц (список предоставить врачу эпидемиологу) из числа пациентов и персонала;
5) провести экстренную профилактику контактных с клиническими проявлениями инфекционного заболевания (при необходимости);"""

# --- ИОХВ ---
IOHV_OPR = """Инфекция области хирургического вмешательства - инфекция хирургического разреза, органа или полости, возникающая в течение первых 30 дней послеоперационного периода (при наличии имплантата – до 90 дней). Делятся на:
1) Поверхностная инфекция области хирургического вмешательства
2) Глубокая инфекция области хирургического вмешательства
3) Инфекция области хирургического вмешательства органа или полости"""

IOHV_POVR = """1) Критерии:
• имеет связь с хирургическим вмешательством;
• не является закономерным развитием основного заболевания;
• включает только кожу и подкожную клетчатку;
• срок развития инфекции не превышает 30 дней после любого оперативного вмешательства (первым днём считается день хирургического вмешательства).
2) Признаки 1-й  группы:
• гнойное отделяемое из раны;
• выделение микроорганизмов из жидкости или ткани, полученной асептически из поверхностного разреза или подкожной клетчатки культуральным или другим методом;
• хирург намеренно открывает рану, при этом микробиологическое исследование не проведено;
3) Признаки 2 -й группы:
• локальное воспаление (боль, гиперемия, отёк) с гипертермией за исключением тех случаев, когда посев отделяемого раны даёт отрицательный результат;
• хирург или лечащий врач поставил диагноз инфекции области хирургического вмешательства."""

IOHV_GLUB = """1) Критерии:
• имеет связь с хирургическим вмешательством;
• не является закономерным развитием основного заболевания;
• вовлекает в гнойный процесс глубокие мягкие ткани (фасциальный и мышечный слои);
• срок развития инфекции не превышает 30 дней после любого оперативного вмешательства (первым днём считается день хирургического вмешательства), а при наличии имплантата – 90 дней.
2) Признаки 1 группы:
• гнойное отделяемое из глубины разреза, но не из органа (полости) в месте данного хирургического вмешательства;
• спонтанное расхождение краёв раны или намеренное её открытие хирургом, когда у пациента имеются признаки инфекции и любым методом выделен микроорганизм;
3) Признаки 2 группы:
• лихорадка (> 38°C), локализованная боль, за исключением тех случаев, когда посев из раны даёт отрицательные результаты;
• при осмотре, во время повторной операции, при гистопатологическом или лучевом методе исследования обнаружен абсцесс или иные признаки инфекции в области хирургического разреза."""

IOHV_ORGAN = """1) Критерии:
• имеет связь с хирургическим вмешательством;
• не является закономерным развитием основного заболевания;
• срок развития инфекции не превышает 30 дней после любого оперативного вмешательства (первым днём считается день хирургического вмешательства), а при наличии имплантата – 90 дней;
• вовлекает в гнойный процесс органы (полости), которые были открыты или затронуты во время операции, исключая кожу, подкожную клетчатку и глубокие мягкие ткани (фасциальный и мышечный слои).
2) Признаки 1 группы:
• гнойное отделяемое из дренажа, установленного в органе (полости);
• свищевой ход, связанный с имплантом;
• гнойное отделяемое в области установки импланта;
• выделение микроорганизмов из жидкости или ткани, полученной асептически из органа (полости) любым методом.
3) Признаки 2 группы:
• при непосредственном осмотре, во время повторной операции, при гистопатологическом или лучевом методе исследования обнаружение абсцесса или иных признаков инфекции, вовлекающей орган или полость."""

DEYSTVIA_IOHV = """1) Информировать руководителя своего структурного подразделения и врача-эпидемиолога о подозрении на указанную инфекцию устно (по телефону) и электронного письма с указанием следующих критериев:
• Ф.И.О. пациента, номер ЭМК;
• наличие в анамнезе хронического процесса
• дата постановки инвазивного устройства;
• дата смены устройства/комплектующих, его промывки;
• дата санации;
• дата появления симптомов, указывающих на ИМП;
• возникшие симптомы;
• взять биологический материал для проведения лабораторного исследования у пациента из потенциального источника инфекции (до начала приема антимикробных препаратов), с целью подтверждения или опровержения диагноза инфекционного заболевания, а также этиологической расшифровки возбудителя (при наличии) инфекционного заболевания;
• при необходимости обеспечить перевод в специализированный стационар, согласно маршрутизации;
• выявить круг контактных лиц (список предоставить врачу эпидемиологу) из числа пациентов и персонала;
• провести экстренную профилактику контактных с клиническими проявлениями инфекционного заболевания;"""

# --- ИК ---
IK_OPR = """Инфекция кровотока - инфекция любой этиологии, при которой положительный посев крови связан с клиническими признаками и симптомами инфекции.
Катетер ассоциированная инфекция кровотока - первичная инфекция кровотока у пациента, которая развилась через 48 часов и более после введения в кровеносное русло катетера и нет связи с другим источником инфекции.
Инфекция, связанная с сосудистым катетером – это местная инфекция в ране входного отверстия катетера и инфекция кровотока у пациента с сосудистым катетером при микробиологическом подтверждении роли сосудистого катетера как фактора передачи возбудителя инфекции."""

IK_LAB = """Должна соответствовать следующим критериям: 
1. Один положительный высев из крови признанного (значимого) патогена*. 
ИЛИ 
2.1. Пациент имеет хотя бы один из следующих симптомов: лихорадка (> 38°C), озноб или гипотензия. 
И 
2.2. Пациент имеет из крови два положительных высева микроорганизма, входящего в состав нормальной микрофлоры кожи** (из двух отдельно взятых посевов в течение 48 часов). 

Примечания: В целях эпидемиологического надзора в данном стандартном определении случая принято следующее: 
- * к патогенным микроорганизмам относятся: Staphylococcus aureus, Грам отрицательные бактерии (Pseudomonas spp, Acinetobacter spp, Achromobacter spp, Stenotrophomonas maltophilia и др.), дрожжеподобные/ плесневые грибы; 
- ** к нормальной микрофлоре кожи отнесены: коагулазоотрицательные стафилококки, Micrococcus spp., Propionibacterium acne, Bacillus spp., Corynebacterium spp. и др."""

DEYSTVIA_IK = """1) Лечащий врач информирует руководителя своего структурного подразделения и врачей-эпидемиологов о подозрении на указанную инфекцию посредством электронного письма с указанием следующих критериев:
• Ф.И.О. пациента, дата рождения, номер ЭМК;
• дата постановки катетера, его локализация;
• дата смены катетера, его промывки;
• название катетера;
• дата появления симптомов, указывающих на КАИК;
• возникшие симптомы;
2) взять биологический материал для проведения лабораторного исследования у пациента из потенциального источника инфекции (до начала приема антимикробных препаратов), с целью подтверждения или опровержения диагноза инфекционного заболевания, а также этиологической расшифровки возбудителя (при наличии) инфекционного заболевания;
3) при необходимости обеспечить перевод в специализированный стационар, согласно маршрутизации;
4) выявить круг контактных лиц (список предоставить врачу эпидемиологу) из числа пациентов и персонала;
5) провести экстренную профилактику контактных с клиническими проявлениями инфекционного заболевания (при необходимости);"""


# --- ОСНОВНЫЕ ФУНКЦИИ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_state[user_id] = MAIN
    buttons = [
        "ИСМП",
        "Отходы",
        "Санэпидрежим в подразделениях",
        "Микробиологический мониторинг",
        "Мероприятия при выявлении инфекционного больного",
        "Аварийные ситуации",
        "Гигиена рук",
        "Производственный контроль"
    ]
    await update.message.reply_text("Главный экран", reply_markup=make_keyboard(buttons))


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text.strip()

    # В начало
    if text == "В начало":
        await start(update, context)
        return

    # Назад
    if text == "Назад":
        current = user_state.get(user_id, MAIN)
        back_map = {
            ISMП: MAIN,
            KRITERII: ISMП,
            STANDART_DEFINITIONS: ISMП,
            IAI: STANDART_DEFINITIONS,
            IDP: STANDART_DEFINITIONS,
            IDP_OPR: IDP,
            IDP_KRIT: IDP,
            IMP: STANDART_DEFINITIONS,
            IMP_VIDY: IMP,
            IOHV: STANDART_DEFINITIONS,
            IOHV_VIDY: IOHV,
            IK: STANDART_DEFINITIONS,
            IK_VIDY: IK,
            VYAVLENНЫЕ: ISMП,
        }
        if current in back_map:
            user_state[user_id] = back_map[current]
        else:
            user_state[user_id] = MAIN
        # Перерисовка меню
        if user_state[user_id] == MAIN:
            await start(update, context)
        elif user_state[user_id] == ISMП:
            await send_ismp_menu(update)
        elif user_state[user_id] == STANDART_DEFINITIONS:
            await send_standart_definitions_menu(update)
        elif user_state[user_id] == IAI:
            await send_iai_menu(update)
        elif user_state[user_id] == IDP:
            await send_idp_menu(update)
        elif user_state[user_id] == IDP_OPR:
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "Пневмония, связанная с оказанием медицинской помощи",
                "Трахеобронхиальные инфекции (бронхит, трахеобронхит, бронхиолит, трахеит без признаков пневмонии)",
                "Прочие инфекции нижних дыхательных путей"
            ]))
        elif user_state[user_id] == IDP_KRIT:
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "пневмонии без микробиологического подтверждения",
                "пневмонии микробиологически подтвержденные",
                "ИВЛ-ассоциированные пневмонии"
            ]))
        elif user_state[user_id] == IMP:
            await send_imp_menu(update)
        elif user_state[user_id] == IMP_VIDY:
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "микробиологически подтвержденная симптоматическая ИМП",
                "не подтвержденная микробиологически симптоматическая ИМП",
                "катетер-ассоциированная ИМП"
            ]))
        elif user_state[user_id] == IOHV:
            await send_iohv_menu(update)
        elif user_state[user_id] == IOHV_VIDY:
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "Поверхностная инфекция области хирургического вмешательства",
                "Глубокая инфекция области хирургического вмешательства",
                "Инфекция области хирургического вмешательства органа или полости"
            ]))
        elif user_state[user_id] == IK:
            await send_ik_menu(update)
        elif user_state[user_id] == IK_VIDY:
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "Лабораторно подтвержденная инфекция кровотока",
                "Катетер-ассоциированная инфекция кровотока (КАИК)",
                "ИК связанная с ЦВК (без положительного высева из крови)",
                "ИК ПВК (без положительного высева из крови)",
                "Генерализованная ИК, связанная с ЦВК (без положительного высева из крови)",
                "Генерализованная ИК, связанная с ПВК (без положительного высева из крови)",
                "Микробиологически подтвержденная инфекция кровотока, связанная с ЦВК",
                "Микробиологически подтвержденная инфекция кровотока, связанная с ПВК"
            ]))
        else:
            await start(update, context)
        return

    # Главное меню
    if user_state.get(user_id) == MAIN:
        if text == "ИСМП":
            user_state[user_id] = ISMП
            await send_ismp_menu(update)
        else:
            await update.message.reply_text(f"Раздел «{text}» пока не реализован.")
        return

    # ИСМП
    if user_state.get(user_id) == ISMП:
        if text == "Комиссия по профилактике ИСМП":
            await update.message.reply_text(COMMISSION)
        elif text == "Критерии ИСМП":
            user_state[user_id] = KRITERII
            await update.message.reply_text("Выберите категорию:",
                                            reply_markup=make_keyboard(["У сотрудников", "У пациентов"]))
        elif text == "Профилактика ИСМП у пациентов и персонала":
            await update.message.reply_text(PROFILAKTIKA)
        elif text == "Аббревиатуры":
            await update.message.reply_text(ABBREVIATURY)
        elif text == "Стандартные определения случаев ИСМП":
            user_state[user_id] = STANDART_DEFINITIONS
            await send_standart_definitions_menu(update)
        elif text == "Программа профилактики ИСМП":
            await update.message.reply_text(
                "📄 Программа профилактики ИСМП на 2025 г.\nСсылка: https://disk.yandex.ru/i/cbNiheeSFy6NvQ")
        elif text == "Выявленные ИСМП":
            user_state[user_id] = VYAVLENНЫЕ
            await update.message.reply_text("Выберите подразделение:", reply_markup=make_keyboard([
                "Стационар + Хирургическое отделение",
                "ОАРИТ",
                "Обобщенные данные"
            ]))
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    # Критерии
    if user_state.get(user_id) == KRITERII:
        if text == "У сотрудников":
            await update.message.reply_text(KRITERII_SOTR)
        elif text == "У пациентов":
            await update.message.reply_text(KRITERII_PAT)
        user_state[user_id] = ISMП
        await send_ismp_menu(update)
        return

    # Выявленные ИСМП
    if user_state.get(user_id) == VYAVLENНЫЕ:
        if text == "Стационар + Хирургическое отделение":
            msg = """В период с 01.12.2025 по 01.11.2025 в отделении стационара + хирургическом отделении был выявлен 61 пациент с признаками инфекционного заболевания. Из них – к критериям ИСМП подходило – 12 пациентов (из них 12 – «ЗАНОСЫ»)
Ознакомиться с протоколами эпидрасследований можно по ссылке: https://disk.yandex.ru/d/jthWuv1YfJatPw"""
            await update.message.reply_text(msg)
        elif text == "ОАРИТ":
            msg = """В период с 01.12.2025 по 01.11.2025 в ОАРИТ было выявлен 26 пациентов с признаками инфекционного заболевания. Из них – к критериям ИСМП подходило – 6 пациентов (из них 5 – «ЗАНОСЫ»; 1 – «СОБСТВЕННОЕ»)
Ознакомиться с протоколами эпидрасследований можно по ссылке: https://disk.yandex.ru/d/jthWuv1YfJatPw"""
            await update.message.reply_text(msg)
        elif text == "Обобщенные данные":
            await update.message.reply_photo("https://disk.yandex.ru/i/WKywmfTxGmfZFg")
        user_state[user_id] = ISMП
        await send_ismp_menu(update)
        return

    # Стандартные определения
    if user_state.get(user_id) == STANDART_DEFINITIONS:
        if text == "ИАИ - имплантат-ассоциированная инфекция":
            user_state[user_id] = IAI
            await send_iai_menu(update)
        elif text == "ИДП – инфекции дыхательных путей":
            user_state[user_id] = IDP
            await send_idp_menu(update)
        elif text == "ИМП - инфекция мочевыводящих путей":
            user_state[user_id] = IMP
            await send_imp_menu(update)
        elif text == "ИОХВ - инфекция области хирургического вмешательства":
            user_state[user_id] = IOHV
            await send_iohv_menu(update)
        elif text == "ИК - инфекции кровотока":
            user_state[user_id] = IK
            await send_ik_menu(update)
        else:
            await update.message.reply_text(f"Раздел «{text}» пока не реализован.")
        return

    # ИАИ
    if user_state.get(user_id) == IAI:
        mapping = {
            "Определение ИАИ": DEF_IAI,
            "Признаки ИАИ": PRIZN_IAI,
            "Факторы риска развития ППИ": FAKTORY_PPI,
            "Типы ППИ": TIPY_PPI,
            "Вероятные пути инфицирования ППИ": PUTI_PPI,
            "Действия в случае выявления ИАИ": DEYSTVIA_IAI
        }
        if text in mapping:
            await update.message.reply_text(mapping[text])
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    # ИДП
    if user_state.get(user_id) == IDP:
        if text == "Определение ИОД":
            user_state[user_id] = IDP_OPR
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "Пневмония, связанная с оказанием медицинской помощи",
                "Трахеобронхиальные инфекции (бронхит, трахеобронхит, бронхиолит, трахеит без признаков пневмонии)",
                "Прочие инфекции нижних дыхательных путей"
            ]))
        elif text == "Критерии ИОД":
            user_state[user_id] = IDP_KRIT
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "пневмонии без микробиологического подтверждения",
                "пневмонии микробиологически подтвержденные",
                "ИВЛ-ассоциированные пневмонии"
            ]))
        elif text == "Действия персонала при подозрении на ИОД":
            await update.message.reply_text(DEYSTVIA_IOD)
        elif text == "Пневмония, связанная с оказанием медицинской помощи":
            await update.message.reply_text(IOD_PNEVMONIA)
        elif text == "пневмонии без микробиологического подтверждения":
            await update.message.reply_text(IOD_KRIT_BEZ_MICROB)
        elif text == "пневмонии микробиологически подтвержденные":
            await update.message.reply_text(IOD_KRIT_S_MICROB)
        elif text == "ИВЛ-ассоциированные пневмонии":
            await update.message.reply_text(IOD_IVL)
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    # ИМП
    if user_state.get(user_id) == IMP:
        if text == "Определение ИМП":
            await update.message.reply_text(IMP_OPR)
        elif text == "Виды и критерии ИМП":
            user_state[user_id] = IMP_VIDY
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "микробиологически подтвержденная симптоматическая ИМП",
                "не подтвержденная микробиологически симптоматическая ИМП",
                "катетер-ассоциированная ИМП"
            ]))
        elif text == "Действия персонала при выявлении ИМП":
            await update.message.reply_text(DEYSTVIA_IMP)
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    if user_state.get(user_id) == IMP_VIDY:
        mapping = {
            "микробиологически подтвержденная симптоматическая ИМП": IMP_MICROB,
            "не подтвержденная микробиологически симптоматическая ИМП": IMP_BEZ_MICROB,
            "катетер-ассоциированная ИМП": IMP_KATETER
        }
        if text in mapping:
            await update.message.reply_text(mapping[text])
            user_state[user_id] = IMP
            await send_imp_menu(update)
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    # ИОХВ
    if user_state.get(user_id) == IOHV:
        if text == "Определение ИОХВ":
            await update.message.reply_text(IOHV_OPR)
        elif text == "Виды и критерии ИОХВ":
            user_state[user_id] = IOHV_VIDY
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "Поверхностная инфекция области хирургического вмешательства",
                "Глубокая инфекция области хирургического вмешательства",
                "Инфекция области хирургического вмешательства органа или полости"
            ]))
        elif text == "Действия персонала при выявлении ИОХВ":
            await update.message.reply_text(DEYSTVIA_IOHV)
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    if user_state.get(user_id) == IOHV_VIDY:
        mapping = {
            "Поверхностная инфекция области хирургического вмешательства": IOHV_POVR,
            "Глубокая инфекция области хирургического вмешательства": IOHV_GLUB,
            "Инфекция области хирургического вмешательства органа или полости": IOHV_ORGAN
        }
        if text in mapping:
            await update.message.reply_text(mapping[text])
            user_state[user_id] = IOHV
            await send_iohv_menu(update)
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    # ИК
    if user_state.get(user_id) == IK:
        if text == "Определения ИК":
            await update.message.reply_text(IK_OPR)
        elif text == "Виды и критерии ИК":
            user_state[user_id] = IK_VIDY
            await update.message.reply_text("Выберите тип:", reply_markup=make_keyboard([
                "Лабораторно подтвержденная инфекция кровотока",
                "Катетер-ассоциированная инфекция кровотока (КАИК)",
                "ИК связанная с ЦВК (без положительного высева из крови)",
                "ИК ПВК (без положительного высева из крови)",
                "Генерализованная ИК, связанная с ЦВК (без положительного высева из крови)",
                "Генерализованная ИК, связанная с ПВК (без положительного высева из крови)",
                "Микробиологически подтвержденная инфекция кровотока, связанная с ЦВК",
                "Микробиологически подтвержденная инфекция кровотока, связанная с ПВК"
            ]))
        elif text == "Действия персонала при выявлении ИК":
            await update.message.reply_text(DEYSTVIA_IK)
        else:
            await update.message.reply_text("Пожалуйста, используйте кнопки.")
        return

    if user_state.get(user_id) == IK_VIDY:
        if text == "Лабораторно подтвержденная инфекция кровотока":
            await update.message.reply_text(IK_LAB)
        # Остальные типы можно добавить по аналогии
        else:
            await update.message.reply_text(f"Раздел «{text}» пока не реализован.")
        user_state[user_id] = IK
        await send_ik_menu(update)
        return

    # Все остальные случаи
    await update.message.reply_text("Пожалуйста, используйте кнопки.")


# --- МЕНЮ ---
def send_ismp_menu(update: Update):
    buttons = [
        "Комиссия по профилактике ИСМП",
        "Критерии ИСМП",
        "Профилактика ИСМП у пациентов и персонала",
        "Аббревиатуры",
        "Стандартные определения случаев ИСМП",
        "Программа профилактики ИСМП",
        "Выявленные ИСМП"
    ]
    return update.message.reply_text("Выберите подраздел ИСМП:", reply_markup=make_keyboard(buttons))


def send_standart_definitions_menu(update: Update):
    buttons = [
        "ИАИ - имплантат-ассоциированная инфекция",
        "ИДП – инфекции дыхательных путей",
        "ИМП - инфекция мочевыводящих путей",
        "ИОХВ - инфекция области хирургического вмешательства",
        "ИК - инфекции кровотока"
    ]
    return update.message.reply_text("Выберите тип ИСМП:", reply_markup=make_keyboard(buttons))


def send_iai_menu(update: Update):
    buttons = [
        "Определение ИАИ",
        "Признаки ИАИ",
        "Факторы риска развития ППИ",
        "Типы ППИ",
        "Вероятные пути инфицирования ППИ",
        "Действия в случае выявления ИАИ"
    ]
    return update.message.reply_text("Выберите раздел по ИАИ:", reply_markup=make_keyboard(buttons))


def send_idp_menu(update: Update):
    buttons = [
        "Определение ИОД",
        "Критерии ИОД",
        "Действия персонала при подозрении на ИОД"
    ]
    return update.message.reply_text("Выберите раздел по ИДП:", reply_markup=make_keyboard(buttons))


def send_imp_menu(update: Update):
    buttons = [
        "Определение ИМП",
        "Виды и критерии ИМП",
        "Действия персонала при выявлении ИМП"
    ]
    return update.message.reply_text("Выберите раздел по ИМП:", reply_markup=make_keyboard(buttons))


def send_iohv_menu(update: Update):
    buttons = [
        "Определение ИОХВ",
        "Виды и критерии ИОХВ",
        "Действия персонала при выявлении ИОХВ"
    ]
    return update.message.reply_text("Выберите раздел по ИОХВ:", reply_markup=make_keyboard(buttons))


def send_ik_menu(update: Update):
    buttons = [
        "Определения ИК",
        "Виды и критерии ИК",
        "Действия персонала при выявлении ИК"
    ]
    return update.message.reply_text("Выберите раздел по ИК:", reply_markup=make_keyboard(buttons))


# --- ЗАПУСК ---
def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    print("✅ Бот запущен!")
    app.run_polling()


if __name__ == '__main__':
    main()